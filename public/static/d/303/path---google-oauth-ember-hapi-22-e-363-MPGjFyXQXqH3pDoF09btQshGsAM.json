{"data":{"site":{"siteMetadata":{"title":"A Blog","author":"Scott Williams"}},"markdownRemark":{"id":"6d2bbe50-34c3-5c24-9052-3f725fbeff5a","excerpt":"OAuth is, to borrow a phrase, a bag of hurt. Not just any bag, but the kind that is thrown over your head right before you’re thrown into a van and driven down…","html":"<p>OAuth is, to borrow a phrase, a bag of hurt. Not just any bag, but the kind that is thrown over your head right before you’re thrown into a van and driven down to Tijuana and ransomed for $50,000. I don’t like OAuth.</p>\n<p>Sometimes, though you need to use it. I’m working on an internal tool at <a href=\"http://tallwave.com\">work</a> and want to make sure that only co-workers can use it. I could do the username/password thing, but the world has enough of those. We use Google docs for the office, so everyone has a Google account that could, theoretically, be used to sign in. Thus, OAuth.</p>\n<p>The tool itself is a web app that uses <a href=\"http://emberjs.com/\">Ember</a> on the front-end and <a href=\"http://hapijs.com/\">Hapi</a> and <a href=\"https://www.mongodb.com/\">MongoDB</a> as the API and database. It’s my first time using Hapi, and I like it quite a bit, seems like a really good tool for API building. </p>\n<p>Since this is a completely separate client and server, it adds a bit of a wrinkle to the OAuth dance. There are plenty of “Sign in with X” libraries out there, but they mostly seem to be written with the intent that the user will only be interacting with that service. In other words, if I was building a Google Docs client app, my life would be easier, but no, I am only authenticating a user’s account and then treating that as the key to my own system… which makes it more manual. It also doesn’t help that Google’s OAuth documentation is lousy. There are many different ways to authenticate, and <a href=\"https://github.com/google/google-auth-library-nodejs\">multiple</a> <a href=\"https://github.com/google/google-api-nodejs-client\">libraries</a> to support the different ways, and they’ve changed over time, so searching for help is difficult. </p>\n<p>Here’s how it’s supposed to work:</p>\n<ol>\n<li>The client (Ember) “signs in with Google”. If this is successful it receives an <code class=\"language-text\">authorizationCode</code>. This code by itself is useless, it just means the user signed in ok.</li>\n<li>The server (Hapi) needs to validate this code and turn it into an <code class=\"language-text\">accessToken</code>.</li>\n<li>If <em>that</em> is successful, we can query the Google API (from the server still) for the account information, verify that they are from Tallwave, and then send credentials back down to the client.</li>\n<li>The client receives the credentials, stores them locally, and includes them for subsequent API requests.</li>\n</ol>\n<p>Errors need to be handled at all the steps along the way too.</p>\n<p><strong>Step 1 — Client Side</strong></p>\n<p><a href=\"https://github.com/Vestorly/torii\">Torii</a> is a pretty good (though a wee bit out of date) library for Ember that handles a good amount of the Google sign in process. Follow its installation instructions and setup the configuration and the proper adapter. Here’s my <code class=\"language-text\">environment.js</code> entry:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* The following properties are in ENV */</span>\ntorii<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n  sessionServiceName<span class=\"token punctuation\">:</span> <span class=\"token string\">'session'</span><span class=\"token punctuation\">,</span>\n  providers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'google-oauth2'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      redirectUri<span class=\"token punctuation\">:</span> signinURL<span class=\"token punctuation\">,</span>\n      apiKey<span class=\"token punctuation\">:</span> googleOAuthAPIKey<span class=\"token punctuation\">,</span>\n      scope<span class=\"token punctuation\">:</span> <span class=\"token string\">'profile email'</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <a href=\"https://developers.google.com/+/web/api/rest/oauth#authorization-scopes\"><code class=\"language-text\">scope</code></a> property is important. That allows you to query for the user’s account later on. The only other point with Torii worth mentioning is how I sent the authorization code to my API. The <code class=\"language-text\">open</code> method on the <code class=\"language-text\">torii-adapters/application.js</code> is called after Google auth finishes, and that is where you create the “session” for authentication. </p>\n<p>By default Ember uses the JSON API for the API layer, and I tend to go with the flow. But in this case, since we’re sending a single value to the server and will throw it away immediately after… Setting up a model seems overkill for that. We can drop down to regular old jQuery for this.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// This is in torii-adapters/application.js</span>\n<span class=\"token function\">open</span><span class=\"token punctuation\">(</span>authentication<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Ember<span class=\"token punctuation\">.</span>RSVP<span class=\"token punctuation\">.</span>Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    Ember<span class=\"token punctuation\">.</span>$<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      method<span class=\"token punctuation\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n      data<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> authorizationCode<span class=\"token punctuation\">:</span> authentication<span class=\"token punctuation\">.</span>authorizationCode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      url<span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// this is the authentication URL in your API</span>\n      success<span class=\"token punctuation\">:</span> Ember<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// forward success/error to the Promise</span>\n      error<span class=\"token punctuation\">:</span> Ember<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sessionStore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> currentUser<span class=\"token punctuation\">:</span> account <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Worth pointing out is that we are expecting our API to return some JSON that will be:</p>\n<ol>\n<li>Stored locally (<code class=\"language-text\">sessionStore</code> is a <a href=\"https://guides.emberjs.com/v2.7.0/applications/services/\">service</a>, which we’ll define later), and will be retrieved later.</li>\n<li>Returning the <code class=\"language-text\">currentUser</code> object will merge it into the underlying session, so that it can be retrieved in routes, components, templates etc. This isn’t permanent storage though, if the user refreshes the page, it’ll be gone, hence <code class=\"language-text\">sessionStore</code>.</li>\n</ol>\n<p><strong>Step 2 — On the Server</strong></p>\n<p>This is where the fun begins. If you’re playing at home, I used Node 5 and Hapi 13.x.x. First, you’ll need to get your credentials from the <a href=\"https://console.developers.google.com\">Google Developer Console</a>. I’m not going to walk through those steps, but you’ll need an OAuth client ID for a Web Application. Specifically, you’ll need the client id, client secret, and redirect URL (yes, even though you won’t be redirecting to anything at this point).</p>\n<p>Then, install the <code class=\"language-text\">googleapis</code> dependency. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install googleapis --save</code></pre></div>\n<p>Now, let’s build a service that sends Google an <code class=\"language-text\">authorizationCode</code> and gets an accessToken back. You’ll call this service from your route handler.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Google <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'googleapis'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> OAuth2 <span class=\"token operator\">=</span> Google<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>OAuth2<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> profile <span class=\"token operator\">=</span> Google<span class=\"token punctuation\">.</span><span class=\"token function\">oauth2</span><span class=\"token punctuation\">(</span><span class=\"token string\">'v2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// pull these from an ENV variable or something else</span>\n<span class=\"token keyword\">const</span> oauthClient <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuth2</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CLIENT_ID</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">CLIENT_SECRET</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">REDIRECT_URL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token comment\">// Omitting the REDIRECT_URL will throw an error</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// callback is a function whose signature is (error, tokens)</span>\n  <span class=\"token function\">getTokens</span><span class=\"token punctuation\">(</span>authorizationCode<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    oauthClient<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span>authorizationCode<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> tokens<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// the authorization code was bad</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// At this point, we have an access token.</span>\n      oauthClient<span class=\"token punctuation\">.</span>credentials <span class=\"token operator\">=</span> tokens<span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Each Google API method takes a params object, </span>\n      <span class=\"token comment\">// which is where you provide your auth credentials</span>\n      <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        auth<span class=\"token punctuation\">:</span> oauthClient\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Retrieve the user's account</span>\n      profile<span class=\"token punctuation\">.</span>userinfo<span class=\"token punctuation\">.</span>v2<span class=\"token punctuation\">.</span>me<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// The response object contains all of the account info</span>\n        \n        <span class=\"token comment\">// This is where you validate if the user is allowed or not.</span>\n        \n        <span class=\"token comment\">// If the user is valid, create a new session for them and save it.</span>\n        <span class=\"token comment\">// It's up to you where you want to save this session. Could be </span>\n        <span class=\"token comment\">// a redis cache, http session, whatever your needs are.</span>\n\n        <span class=\"token comment\">// After that, we're going to send our session token and user </span>\n        <span class=\"token comment\">// account back.</span>\n        \n\n        <span class=\"token keyword\">const</span> sessionJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n          token<span class=\"token punctuation\">:</span> someSessionToken<span class=\"token punctuation\">,</span>\n          account<span class=\"token punctuation\">:</span> response\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> newSession<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>That’s kind of a mouthful and could definitely stand a good refactoring, but it goes through the steps needed to get some information from Google. You can see more <a href=\"http://google.github.io/google-api-nodejs-client/12.4.0/index.html\">APIs</a> you can call, but the documentation on a lot of them is rather sparse. For example, adding the <code class=\"language-text\">oauthClient</code> to <code class=\"language-text\">params</code> is not apparent, but necessary for each call.</p>\n<p>We’ve now determined if the user should actually have access to what they just signed in to and sent the response back to the client. That’s pretty good! Refresh your beverage, take a deep breath and then let’s get handle that response and get our client in order to keep moving.</p>\n<p><strong>Step 3 — Back on the Client</strong></p>\n<p>You might have noticed again that we did not send the session information back in JSON API format either. This was intentional since we aren’t going to be storing this in the standard Ember store, and therefore don’t need the additional benefit of using something that standardized. You could if you wanted to, but for this occasion, I did not want to set up a model (or in this case model<em>s</em> to support the nested structure).</p>\n<p>Back up in our <code class=\"language-text\">Ember.RSVP.Promise</code> handler there was this line:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// In torii-adapters/application.js</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sessionStore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Once you receive a response, you’ll need to store it. You could use Ember Data, but that felt overkill to me; I needed to access the tokens within the response for subsequent API calls, and nothing else. I ended up building an <a href=\"https://guides.emberjs.com/v2.8.0/applications/services/\">Ember service</a> that serialized the content and stored it in <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage\">localStorage</a>. You can go your own way too.</p>\n<p><strong>Step 4 — Making authenticated requests</strong></p>\n<p>We’re authorized (or have displayed a fancy error message) and are ready to make actual requests to get actual data. I like to authenticate my API requests by including my authorization token in the <code class=\"language-text\">Authorization</code> header on requests. Ember allows for this by overriding the <code class=\"language-text\">headers</code> computed property in your Adapter:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// adapters/application.js</span>\n  headers<span class=\"token punctuation\">:</span> Ember<span class=\"token punctuation\">.</span><span class=\"token function\">computed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> account <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sessionStore'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>account<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'Authorization'</span><span class=\"token punctuation\">:</span> account<span class=\"token punctuation\">.</span>_id\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">volatile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>Step 5 — Verify authentication on the server</strong></p>\n<p>There are may ways to <a href=\"http://hapijs.com/tutorials/auth\">authenticate requests with Hapi</a>. Hapi calls these “Schemes”. A Scheme is made up of multiple Strategies but since we only have one, we’ll just refer to it as a Scheme.</p>\n<p>You define a Scheme as a function that takes a <code class=\"language-text\">server</code> and some <code class=\"language-text\">options</code> as arguments and go from there. Here’s <code class=\"language-text\">api-auth.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// These are the standard Hapi request/reply arguments</span>\n    authenticate<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token comment\">// Get the session token from the HTTP Headers of the request</span>\n      <span class=\"token keyword\">const</span> req <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>raw<span class=\"token punctuation\">.</span>req<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> authorization <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>authorization<span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// Fail quickly if it isn't present.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>authorization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reply</span><span class=\"token punctuation\">(</span>Boom<span class=\"token punctuation\">.</span><span class=\"token function\">unauthorized</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Basic'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// Pull the credentials from the session store that are </span>\n      <span class=\"token comment\">// associated with the session token. Fail if it's not valid.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>tokenIsValid<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reply</span><span class=\"token punctuation\">(</span>Boom<span class=\"token punctuation\">.</span><span class=\"token function\">unauthorized</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authenication failed'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Basic'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// Authenticated, so send the credentials along the chain in </span>\n      <span class=\"token comment\">// case they need to be used later.</span>\n      <span class=\"token keyword\">return</span> reply<span class=\"token punctuation\">.</span><span class=\"token keyword\">continue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> credentials<span class=\"token punctuation\">:</span> credentials <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now that we’ve defined our Scheme, we need to register it with Hapi. Wherever the server is set up add this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Import our Scheme</span>\n<span class=\"token keyword\">const</span> apiScheme <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./config/api-scheme'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">register</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// Auth</span>\n  <span class=\"token comment\">// Schemes have a name which you define here.</span>\n  server<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">scheme</span><span class=\"token punctuation\">(</span><span class=\"token string\">'auth-scheme'</span><span class=\"token punctuation\">,</span> apiScheme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// Strategies also have a name. This is what you'll refer </span>\n  <span class=\"token comment\">// to when setting schemes for routes.</span>\n  server<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">strategy</span><span class=\"token punctuation\">(</span><span class=\"token string\">'basic-strategy'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'auth-scheme'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// You can declare all routes to use a one Strategy by default.</span>\n  server<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">(</span><span class=\"token string\">'basic-strategy'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// Routes might go here</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If you do use a default auth strategy, you can override that on individual routes in their handler config:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  method<span class=\"token punctuation\">:</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span>\n  path<span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n  handler<span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> reply<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">reply</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  config<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    auth<span class=\"token punctuation\">:</span> <span class=\"token string\">'another-strategy'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Or use the boolean <code class=\"language-text\">false</code> to skip auth altogether for a route, such as your session creation API.</p>\n<p>And we’re done! You now have an authenticated API. There are plenty of other points that could be expanded on, but it’s getting a little long in the tooth now.</p>\n<p><strong>Wait, why not use Bell?</strong></p>\n<p>The Hapi organization maintains a project called <a href=\"https://github.com/hapijs/bell\">Bell</a> that is a “Third-party login plugin for hapi”, including OAuth services. It’s great, but the catch is that since half of our authentication takes place in the browser, we can’t quite use it the way it is intended to be used.</p>","frontmatter":{"title":"Google OAuth, Ember, Hapi","date":"September 07, 2016"}}},"pageContext":{"slug":"/google-oauth-ember-hapi/","previous":{"fields":{"slug":"/maine-and-back-again/"},"frontmatter":{"title":"Maine and Back Again"}},"next":{"fields":{"slug":"/race-report-phoenix-rock-n-roll-half-marathon\u001b/"},"frontmatter":{"title":"Race Report — Phoenix Rock 'n Roll Half Marathon"}}}}