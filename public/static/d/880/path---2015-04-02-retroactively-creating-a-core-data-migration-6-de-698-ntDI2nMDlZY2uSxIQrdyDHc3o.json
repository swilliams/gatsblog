{"data":{"site":{"siteMetadata":{"title":"A Blog","author":"Scott Williams"}},"markdownRemark":{"id":"b3775f93-ffc5-57ac-8703-3080166fe1c0","excerpt":"Let’s take a  completely hypothetical  situation where you’re developing an app that uses  Core Data  for the local storage and have a bunch of beta testers…","html":"<p>Let’s take a <em>completely hypothetical</em> situation where you’re developing an app that uses <a href=\"https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/CoreData/cdProgrammingGuide.html\">Core Data</a> for the local storage and have a bunch of beta testers eagerly awaiting the next version before your product launch. Your previous attitude towards the data model was something along the lines of <em>“It’s still pre-1.0, I’m not bothering with migrations yet, just delete and reinstall, c’mon.”</em> However, you forgot that requiring the beta testers to deal with that isn’t exactly a friendly experience for them, and you made at least three changes to the data model since your last Beta release. Now if they run the app it’ll crash immediately because the database isn’t in sync with the data model.</p>\n<p>Oops.</p>\n<p>Usually when you make changes to the data model, you do so by creating a new version and telling the <code class=\"language-text\">NSPersistentStoreCoordinator</code> to perform lightweight migrations, <em>then</em> make your changes. Adding a new version of the data model after changes were made accomplishes nothing. Fortunately, you’re not screwed. We’re going to jump back in time, grab the old data model then pretend it was there all along.</p>\n<p>Your <code class=\"language-text\">MyProject.xcdatamodeld</code> file is actually a directory. If you browse it in the Finder or Terminal, you’ll see more folders inside it, one for each version of your model. Inside those folders is a file simply called <code class=\"language-text\">contents</code>. This is an XML representation of the editor you see in Xcode.</p>\n<h3 id=\"step-1--find-the-data-model-from-the-last-beta-version-you-released\"><a href=\"#step-1--find-the-data-model-from-the-last-beta-version-you-released\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1 — Find the data model from the last beta version you released</h3>\n<p>Look through the history the <code class=\"language-text\">xcdatamodeld</code> file in your source control system <sup id=\"fnref:1\"><a href=\"#fn:1\" rel=\"footnote\">1</a></sup>. Hopefully you’ve been tagging all of your releases and can just checkout that specific one.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&gt; git checkout 1.0-beta4</code></pre></div>\n<p>If not, you can mess around with <code class=\"language-text\">git log</code> to figure out where to go. This snippet can help you see the commits for a single file:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&gt; git log --pretty=format:&#39;%h : %s&#39; --graph -n 45 FILENAME</code></pre></div>\n<p>Then, checkout the particular commit with the right version.</p>\n<h3 id=\"step-2--copy-the-contents-file\"><a href=\"#step-2--copy-the-contents-file\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2 — Copy the contents file</h3>\n<p>Find  the <code class=\"language-text\">contents</code> file within your <code class=\"language-text\">.xcdatamodeld</code> file. Copy all that XML somewhere safe.</p>\n<p>Go back to your <code class=\"language-text\">HEAD</code> or wherever you were.</p>\n<h3 id=\"step-3--create-the-new-version-of-the-data-model\"><a href=\"#step-3--create-the-new-version-of-the-data-model\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3 — Create the new version of the data model</h3>\n<p>If you didn’t know, the process is:</p>\n<ul>\n<li>Open the <code class=\"language-text\">.xcdatamodeld</code> file in Xcode</li>\n<li>In the Editor menu, click “Add Model Version”. Follow the instructions.</li>\n<li>Open the File Inspector for your <code class=\"language-text\">.xcdatamodeld</code>. There is a Model Version segment in the inspector, make sure it’s on the version you just created.</li>\n</ul>\n<p>Now you have two data models that are identical. Let’s change the history on the original one.</p>\n<h3 id=\"step-4--change-history\"><a href=\"#step-4--change-history\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 4 — Change history</h3>\n<p>Close Xcode. That’s not mandatory but I’ve had it crash when mucking about with these files, and it’s just not worth the hassle.</p>\n<p>Open the <code class=\"language-text\">contents</code> file for the <strong>original</strong> <code class=\"language-text\">.xcdatamodeld</code> in a text editor.</p>\n<p>Paste in the version you created in Step 2.</p>\n<p>Open Xcode. If you haven’t set up the <code class=\"language-text\">NSPersistentStoreCoordinator</code> to run migrations, do so now. <a href=\"http://www.raywenderlich.com/27657/how-to-perform-a-lightweight-core-data-migration\">This tutorial is pretty good</a>.</p>\n<p>Now when the app runs, the migrations update the users’ data and keep things from crashing.</p>\n<p>Note: This is for <em>lightweight</em> migrations. Custom migrations are more complicated. <a href=\"http://www.objc.io/issue-4/core-data-migration.html\">objc.io</a> has a great article on these. I don’t know if you can play fast and loose with the data model file like you can here though.</p>\n<div class=\"footnotes\">\n  <ol>\n    <li class=\"footnote\" id=\"fn:1\">\n  <p>You ARE using Source Control, right? Sometimes new developers will ask me why they need Source Control. I usually parrot the usual answers - branching is good, undo mistakes, tool integration, etc - but situations like this are where it really shines. Without source control here, you'd be hosed. You'd have to manually fix the XML in the contents file, which would be monumentally hard or altogether impossible depending on what changed and how good your memory is.</p>\n</li>\n  </ol>\n</div>","frontmatter":{"title":"Retroactively Creating a Core Data Migration","date":"April 02, 2015"}}},"pageContext":{"slug":"/2015/04/02/retroactively-creating-a-core-data-migration/","previous":{"fields":{"slug":"/2015/04/01/two-factor-authentication-for-github/"},"frontmatter":{"title":"Two Factor Authentication for GitHub"}},"next":{"fields":{"slug":"/2015/04/04/half-baked-business-idea-augmented-paintball-slash-airsoft-slash-laser-tag/"},"frontmatter":{"title":"Half-baked Business Idea - Augmented Paintball/Airsoft/Laser Tag"}}}}